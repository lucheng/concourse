<?php defined('IN_TS') or die('Access Denied.');//苹果梦工厂switch($ts){		case "":				if(intval($TS_USER['user']['isadmin'])==0){			header("Location: ".SITE_URL);			exit;		}				$userid = $TS_USER['user']['userid'];				$modelid = $TS_APP['options']['modelid'];		//获取模型属性 		$strModel = $db->fetch_all_assoc("select * from ".dbprefix."apple_virtue where `modelid`='$modelid'");				$title = '生产苹果机';		include template('create');		break;			case "do":				$userid = intval($TS_USER['user']['userid']);				if($userid == 0){			header("Location: ".SITE_URL);			exit;		}				$title = trim($_POST['title']);		$content = trim($_POST['content']);				//获取appleid		$db->query("insert into ".dbprefix."apple (`userid`,`title`,`content`,`addtime`) values ('$userid','$title','$content','".time()."')");		$appleid = $db->insert_id();				//处理图片		if (!empty($_FILES)) {						$uptypes = array('jpg','png','gif');						//1000个文件一个目录 			$menu2=intval($appleid/1000);			$menu1=intval($menu2/1000);			$path = $menu1.'/'.$menu2;						$dest_dir='uploadfile/apple/'.$path;						createFolders($dest_dir);						$photoname = $_FILES["photo"]['name'];						$arrType = explode('.',$photoname);			$phototype = $arrType[1];						if (in_array($phototype,$uptypes)) {				//上传图片				$fileInfo=pathinfo($photoname);				$extension=$fileInfo['extension'];								$newphotoname = $appleid.'.'.$extension;								$dest=$dest_dir.'/'.$newphotoname;				move_uploaded_file($_FILES['photo']['tmp_name'], mb_convert_encoding($dest,"gb2312","UTF-8"));				chmod($dest, 0777); 								$photo = $path.'/'.$newphotoname;								$db->query("update ".dbprefix."apple set `path`='$path',`photo`='$photo' where `appleid`='$appleid'");							}		}				//处理模型参数		$modelid = $_POST['modelid'];		$virtueid = $_POST['virtueid'];		$parameter = $_POST['parameter'];				foreach($virtueid as $key=>$item){			$db->query("insert into ".dbprefix."apple_index (`appleid`,`modelid`,`virtueid`,`parameter`) values ('$appleid','$modelid','".$item."','".trim($parameter[$key])."')");		}				header("Location: ".SITE_URL.tsurl('apple','show',array('appleid'=>$appleid)));				break;}